import streamlit as st
import pandas as pd
import plotly.express as px

st.set_page_config(page_title="2024 ëŒ€í•œë¯¼êµ­ ì¢…í•©ì†Œë“ì„¸ ê³„ì‚°ê¸°", layout="wide")
st.title("ğŸ‡°ğŸ‡· 2024 ëŒ€í•œë¯¼êµ­ ì¢…í•©ì†Œë“ì„¸ ìë™í™” ì›¹ ì•±")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âœ… 1. ì„¸ìœ¨ ê³„ì‚° í•¨ìˆ˜ (2024 ëŒ€í•œë¯¼êµ­ ì¢…í•©ì†Œë“ì„¸ ëˆ„ì§„ê³µì œ ê¸°ì¤€)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def calc_tax_2024(income_man):
    income = income_man * 10000  # ë§Œì› â†’ ì› ë‹¨ìœ„ ë³€í™˜

    # ì„¸ìœ¨ êµ¬ê°„ ë° ëˆ„ì§„ê³µì œ (2024ë…„ ê¸°ì¤€)
    brackets = [
        (14_000_000, 0.06, 0),
        (50_000_000, 0.15, 1_080_000),
        (88_000_000, 0.24, 5_220_000),
        (150_000_000, 0.35, 14_900_000),
        (300_000_000, 0.38, 19_400_000),
        (500_000_000, 0.40, 25_400_000),
        (1_000_000_000, 0.42, 33_400_000),
        (float('inf'), 0.45, 63_400_000),
    ]

    for limit, rate, deduction in brackets:
        if income <= limit:
            tax = income * rate - deduction
            return round(tax / 10000, 0)  # ë§Œì› ë‹¨ìœ„ë¡œ ë°˜í™˜

def add_tax_columns(df):
    df["ì„¸ê¸ˆ(ë§Œì›)"] = df["ì—°ì†Œë“(ë§Œì›)"].apply(calc_tax_2024)
    df["ì„¸ìœ¨(%)"] = (df["ì„¸ê¸ˆ(ë§Œì›)"] / df["ì—°ì†Œë“(ë§Œì›)"] * 100).round(2)
    # âœ… ì†Œë“êµ¬ê°„ ê³„ì‚°ë„ ì´ ì•ˆì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬
    bins = [0, 3000, 5000, 8000, 12000, 20000]
    labels = ["â‰¤3000", "3001~5000", "5001~8000", "8001~12000", ">12000"]
    df["ì†Œë“êµ¬ê°„"] = pd.cut(df["ì—°ì†Œë“(ë§Œì›)"], bins=bins, labels=labels, include_lowest=True)
    return df

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âœ… 2. ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "data" not in st.session_state:
    df_init = pd.DataFrame({
        "ì´ë¦„": ["ê¹€ë¯¼ì¤€", "ì´ì„œìœ¤", "ë°•ì§€í˜¸", "ìµœì§€ìš°", "ì •í˜„ìš°"],
        "ì—°ì†Œë“(ë§Œì›)": [2800, 5200, 7500, 9500, 13000]
    })
    st.session_state.data = add_tax_columns(df_init)

df = st.session_state.data

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âœ… 3. ë°ì´í„° ì¶”ê°€ / ì‚­ì œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.sidebar.header("ë°ì´í„° ì¶”ê°€ / ì‚­ì œ")

with st.sidebar:
    name = st.text_input("ì´ë¦„ ì…ë ¥")
    income = st.number_input("ì—°ì†Œë“ (ë§Œì›)", min_value=1000, max_value=20000, step=100)

    if st.button("ë°ì´í„° ì¶”ê°€"):
        if name.strip() == "":
            st.warning("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.")
        else:
            new_row = pd.DataFrame({"ì´ë¦„": [name], "ì—°ì†Œë“(ë§Œì›)": [income]})
            st.session_state.data = pd.concat([st.session_state.data, new_row], ignore_index=True)
            st.session_state.data = add_tax_columns(st.session_state.data)
            st.success(f"{name}ë‹˜ì˜ ë°ì´í„°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!")

    if len(st.session_state.data) > 0:
        delete_name = st.selectbox("ì‚­ì œí•  ì´ë¦„ ì„ íƒ", st.session_state.data["ì´ë¦„"])
        if st.button("ë°ì´í„° ì‚­ì œ"):
            st.session_state.data = st.session_state.data[st.session_state.data["ì´ë¦„"] != delete_name]
            st.success(f"{delete_name}ë‹˜ì˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âœ… 4. ë°ì´í„° í…Œì´ë¸” í‘œì‹œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.subheader("ğŸ“‹ ë°ì´í„° í…Œì´ë¸”")
st.dataframe(st.session_state.data, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âœ… 5. ìš”ì•½ ì •ë³´
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.subheader("ğŸ“Š ìš”ì•½ ì •ë³´")
col1, col2, col3 = st.columns(3)
col1.metric("ì´ ì¸ì›", len(st.session_state.data))
col2.metric("ì´ ì—°ì†Œë“(ë§Œì›)", int(st.session_state.data["ì—°ì†Œë“(ë§Œì›)"].sum()))
col3.metric("í‰ê·  ì„¸ìœ¨(%)", round(st.session_state.data["ì„¸ìœ¨(%)"].mean(), 2))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âœ… 6. íŒŒì´ì°¨íŠ¸ (ì†Œë“ êµ¬ê°„ë³„)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.subheader("ğŸ¨ ì†Œë“ êµ¬ê°„ë³„ ì¸ì› ë¹„ìœ¨")
fig = px.pie(st.session_state.data, names="ì†Œë“êµ¬ê°„", title="ì—°ì†Œë“ êµ¬ê°„ ë¹„ìœ¨",
             color="ì†Œë“êµ¬ê°„",
             color_discrete_sequence=["#B0E0FF", "#FFF9A6", "#FFD6A5", "#FFA1A1", "#C7A6FF"])
st.plotly_chart(fig, use_container_width=True)

